<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Log browser</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Rubik:wght@400;500;600">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<form id="path-form">
  <label for="path-input">Enter path to file:</label>
  <div>
    <input type="text" id="path-input" name="path" placeholder="eg. home/student/NASA" required>
    <input type="submit" id="path-submit" value="Open">
  </div>
</form>
<main>
  <div id="logs-section">
    <form id="date-range-form">
      <div class="date-form-field">
        <label for="start-date" class="date-label">From:</label>
        <input type="date" id="start-date" class="date-input" name="start-date">
      </div>
      <div class="date-form-field">
        <label for="end-date" class="date-label">To:</label>
        <input type="date" id="end-date" class="date-input" name="end-date">
      </div>
    </form>
    <form id="logs"></form>
  </div>
  <div id="details">
    <h2 id="details-title">Details</h2>
    <div class="details-data">
      <label for="host">Remote host:</label>
      <span id="host"></span>
    </div>
    <div class="details-data">
      <label for="date">Date:</label>
      <span id="date"></span>
    </div>
    <div id="time-section">
      <div class="details-data">
        <label for="time">Time:</label>
        <span id="time"></span>
      </div>
      <div class="details-data">
        <label for="timezone">Timezone:</label>
        <span id="timezone"></span>
      </div>
    </div>
    <div id="status-section">
      <div class="details-data">
        <label for="status-code">Status code:</label>
        <span id="status-code"></span>
      </div>
      <div class="details-data">
        <label for="method">Method:</label>
        <span id="method"></span>
      </div>
    </div>
    <div class="details-data">
      <label for="resource">Resource:</label>
      <span id="resource"></span>
    </div>
    <div class="details-data">
      <label for="size">Size:</label>
      <span id="size"></span>
    </div>
  </div>
  <div id="nav-buttons">
    <button id="prev-btn" class="nav-btn">Previous</button>
    <button id="next-btn" class="nav-btn">Next</button>
  </div>
</main>
<svg id="blue-wave" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320">
  <path fill="#6e72fc" fill-opacity="1"
        d="M0,192L48,170.7C96,149,192,107,288,106.7C384,107,480,149,576,176C672,203,768,213,864,213.3C960,213,1056,203,1152,176C1248,149,1344,107,1392,85.3L1440,64L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
</svg>
<svg id="purple-wave-top" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320">
  <path fill="#ad1deb" fill-opacity="1"
        d="M0,192L48,170.7C96,149,192,107,288,106.7C384,107,480,149,576,176C672,203,768,213,864,213.3C960,213,1056,203,1152,176C1248,149,1344,107,1392,85.3L1440,64L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
</svg>
<svg id="white-wave" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320">
  <path fill="white" fill-opacity="1"
        d="M0,192L48,170.7C96,149,192,107,288,106.7C384,107,480,149,576,176C672,203,768,213,864,213.3C960,213,1056,203,1152,176C1248,149,1344,107,1392,85.3L1440,64L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
</svg>
<svg id="purple-wave-bottom" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320">
  <path fill="#ad1deb" fill-opacity="1"
        d="M0,192L48,170.7C96,149,192,107,288,106.7C384,107,480,149,576,176C672,203,768,213,864,213.3C960,213,1056,203,1152,176C1248,149,1344,107,1392,85.3L1440,64L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
</svg>

<script type="text/javascript" src="/eel.js"></script>
<script>
  // Listen for path form submission and fetch logs
  const pathForm = document.getElementById('path-form');
  pathForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const path = new FormData(pathForm).get('path');

    eel.read_logs(path)(({status, logs}) => {
      if (status === 'success') {
        // Display all fetched logs
        displayLogs(logs);

        // Set start date to the first date in the logs
        eel.get_js_date(logs[0])((date) => {
          document.getElementById('start-date').valueAsDate = new Date(date);
        });

        // Set end date to the last date in the logs
        eel.get_js_date(logs.at(-1))((date) => {
          document.getElementById('end-date').valueAsDate = new Date(date);
        });

        // Listen for changes in log selection and display log details
        const logsForm = document.getElementById('logs');
        logsForm.addEventListener('change', (e) => {
          e.preventDefault();
          const log = new FormData(logsForm).get('log');
          showLogDetails(log);
        });

        // Listen for changes in date range and filter logs accordingly
        const dateRangeForm = document.getElementById('date-range-form');
        dateRangeForm.addEventListener('change', (e) => {
          e.preventDefault();
          const startDate = new FormData(dateRangeForm).get('start-date');
          const endDate = new FormData(dateRangeForm).get('end-date');

          eel.filter_logs_by_date(logs, startDate, endDate)(displayLogs);
          resetLogDetails();
        });
      } else {
        document.getElementById('logs').innerHTML = `<p id="not-found-err">File not found</p>`;
        resetLogDetails();
      }
    });
  });

  document.getElementById('next-btn').addEventListener('click', (e) => {
    e.preventDefault();
    selectNextLog();
  });

  document.getElementById('prev-btn').addEventListener('click', (e) => {
    e.preventDefault();
    selectPreviousLog();
  });

  const displayLogs = (logs) => {
    document.getElementById('logs').innerHTML = logs.map((log, index) =>
      `<input id="log-${index}" type="radio" name="log" value='${log}' style="display: none"><label for="log-${index}">${log.slice(0, 50)}...</label>`
    ).join('');
  }

  const showLogDetails = (log) => {
    eel.get_log_details(log)((details) => {
      document.getElementById('host').innerText = details['host'];
      document.getElementById('date').innerText = details['date'];
      document.getElementById('time').innerText = details['time'];
      document.getElementById('timezone').innerText = details['timezone'];
      document.getElementById('status-code').innerText = details['status_code'];
      document.getElementById('method').innerText = details['method'];
      document.getElementById('resource').innerText = details['resource'];
      document.getElementById('size').innerText = details['size'];
    });
  }

  const resetLogDetails = () => {
    document.getElementById('host').innerText = '';
    document.getElementById('date').innerText = '';
    document.getElementById('time').innerText = '';
    document.getElementById('timezone').innerText = '';
    document.getElementById('status-code').innerText = '';
    document.getElementById('method').innerText = '';
    document.getElementById('resource').innerText = '';
    document.getElementById('size').innerText = '';
  }

  const selectNextLog = () => {
    const selectedLog = document.querySelector('input[name="log"]:checked');
    if (selectedLog) {
      // Next sibling twice because of the label
      const nextLog = selectedLog.nextElementSibling.nextElementSibling;

      if (nextLog && nextLog.type === 'radio') {
        nextLog.checked = true;
        showLogDetails(nextLog.value);
      }
    }
  }

  const selectPreviousLog = () => {
    const selectedLog = document.querySelector('input[name="log"]:checked');
    if (selectedLog) {
      // Previous sibling twice because of the label
      const previousLog = selectedLog.previousElementSibling.previousElementSibling;

      if (previousLog && previousLog.type === 'radio') {
        previousLog.checked = true;
        showLogDetails(previousLog.value);
      }
    }
  }
</script>
</body>
</html>
